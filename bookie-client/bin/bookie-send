#!/usr/bin/env ruby

#For development
$LOAD_PATH.concat Dir.glob(File.join(Dir.pwd, "../*/lib"))

#For development
ENV['TORQUEROOT'] = 'snapshot'

require 'bookie-client'

#for development
#config = Bookie::Config.new('/etc/bookie/config.json')
config = Bookie::Config.new('snapshot/config.json')

#For development
config.excluded_users = Set.new([])

config.connect

sender = Bookie::Client::LinuxSender.new(config)

#Process arguments.
date = nil
will_decommission = false
system_end_time = Time.new
arg_offset = 0

if /\d{4}-\d{2}-\d{2}/.match(ARGV[arg_offset])
  date = Date.parse(ARGV[arg_offset])
end

if ARGV[arg_offset] == "--decommission"
  hostname = ARGV[arg_offset + 1] || sender.hostname
  if ARGV[arg_offset + 2]
    system_end_time = Time.parse(ARGV[arg_offset + 2])
  end
  will_decommission = true
  arg_offset += 3
end

sender.send_data(date)
sender.decommission(hostname, system_end_time) if will_decommission
