#Borrows a few tricks from the gem2rpm default template

%define _prefix /opt/bookie
%define gemdir %{_prefix}

Name: 		bookie_accounting
Version:	<%= bookie_spec.version %>
Release:	1%{?dist}
Summary:	<%= bookie_spec.summary[0 ... -1] %>

#To do: change group?
Group:		System Management
License:	MIT
URL:	    http://github.com/blm768/bookie	
<% sources.each_with_index do |src, i| %>
Source<%= i %>:	<%= src %>
<% end %>
BuildRoot:	%(mktemp -ud %{_tmppath}/%{name}-%{version}-%{release}-XXXXXX)

BuildRequires:	ruby-devel, rubygems, mysql-devel, sqlite-devel
Requires:		rubygems, mysql-libs, sqlite

%description
<% bookie_spec.description %>


%prep
export CONFIGURE_ARGS="--with-cflags='%{optflags}'"

<% sources.each_with_index do |src, i| %>
  gem install --local --install-dir .%{gemdir} \
	--bindir .%{_bindir} \
	--no-rdoc --no-ri \
	-V \
	--force %{SOURCE<%= i %>}
<% end %>


%build


%install
rm -rf %{buildroot}
mkdir -p %{buildroot}%{gemdir}
cp -r .%{gemdir}/* %{buildroot}%{gemdir}
echo "{}" > %{buildroot}%{_prefix}/config.json
chmod 600 %{buildroot}%{_prefix}/config.json
cat > %{buildroot}%{_bindir}/bookie-env <<-EOF
#!/bin/sh
export GEM_HOME=%{gemdir}
#To do: change path based on Ruby version.
export GEM_PATH=\$GEM_HOME:/usr/lib/ruby/gems/1.8
export PATH=%{_bindir}:\$PATH
export BOOKIE_CONFIG=%{_prefix}/config.json

eval "\$@"
EOF
chmod 700 %{buildroot}%{_bindir}/bookie-env


%clean
rm -rf %{buildroot}


%files
%defattr(-,root,root,-)
%{gemdir}


%changelog

